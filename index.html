<!DOCTYPE html>
<html lang="ru">
<head> 
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Эко-Карта Москвы</title>
  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <!-- Шрифт -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;600&display=swap" rel="stylesheet">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body, html {
      height: 100%;
      font-family: 'Manrope', sans-serif;
      background-color: #f8f9f7;
      color: #2d3748;
    }

    #map {
      width: 100%;
      height: 100vh;
      position: relative;
    }

    /* Панель управления */
    #controls {
      position: absolute;
      top: 24px;
      right: 24px;
      width: 320px;
      background: rgba(255, 255, 255, 0.85);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      border-radius: 20px;
      padding: 28px;
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.08);
      z-index: 1000;
      border: 1px solid rgba(220, 224, 220, 0.6);
    }

    @media (max-width: 768px) {
      #controls {
        width: calc(100% - 48px);
        right: 24px;
        left: 24px;
        top: 16px;
        max-height: 85vh;
        overflow-y: auto;
      }
    }

    #controls h2 {
      font-size: 20px;
      font-weight: 600;
      color: #2d3748;
      margin-bottom: 20px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .filter-group {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-bottom: 22px;
    }

    .filter-btn {
      flex: 1;
      min-width: 70px;
      padding: 10px 12px;
      border: 1px solid #cbd5e0;
      border-radius: 14px;
      background: #f8fafc;
      font-size: 14px;
      font-weight: 500;
      color: #4a5568;
      cursor: pointer;
      transition: all 0.25s ease;
      text-align: center;
    }

    .filter-btn:hover {
      background: #edf2f7;
    }

    .filter-btn.active.plastic { background: #dbeafe; border-color: #bfdbfe; color: #1d4ed8; }
    .filter-btn.active.paper   { background: #dcfce7; border-color: #bbf7d0; color: #047857; }
    .filter-btn.active.glass   { background: #fee2e2; border-color: #fecaca; color: #b91c1c; }
    .filter-btn.active.metal   { background: #fef3c7; border-color: #fde68a; color: #b45309; }

    .point-selector {
      width: 100%;
      padding: 12px 16px;
      border: 1px solid #cbd5e0;
      border-radius: 14px;
      background: white;
      font-size: 15px;
      margin-bottom: 20px;
      color: #2d3748;
      font-family: 'Manrope', sans-serif;
    }

    .route-btn {
      width: 100%;
      padding: 13px;
      background: #4caf50;
      color: white;
      border: none;
      border-radius: 14px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.2s;
    }

    .route-btn:hover {
      background: #43a047;
    }

    .route-info {
      position: absolute;
      bottom: 24px;
      right: 24px;
      background: rgba(255, 255, 255, 0.85);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      padding: 20px;
      border-radius: 20px;
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.08);
      z-index: 1000;
      display: none;
      max-width: 300px;
      border: 1px solid rgba(220, 224, 220, 0.6);
    }

    .route-info.show {
      display: block;
    }

    .route-info h3 {
      font-size: 16px;
      font-weight: 600;
      margin-bottom: 10px;
      color: #2d3748;
    }

    .category-badge {
      display: inline-block;
      padding: 3px 10px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 600;
      margin: 2px 4px 2px 0;
      background: #f1f5f9;
      color: #4a5568;
    }

    .plastic { background: #dbeafe; color: #1d4ed8; }
    .paper   { background: #dcfce7; color: #047857; }
    .glass   { background: #fee2e2; color: #b91c1c; }
    .metal   { background: #fef3c7; color: #b45309; }

    /* Leaflet контролы — сделаем их менее навязчивыми */
    .leaflet-control-zoom {
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    .leaflet-control-zoom a {
      background: white;
      color: #4a5568;
      width: 32px;
      height: 32px;
      line-height: 32px;
      font-size: 18px;
    }
  </style>
</head>
<body>
  <div id="map"></div>

  <div id="controls">
    <h2>♻️ Пункты сортировки</h2>
    <div class="filter-group">
      <button class="filter-btn plastic active" data-category="plastic">Пластик</button>
      <button class="filter-btn paper active" data-category="paper">Бумага</button>
      <button class="filter-btn glass active" data-category="glass">Стекло</button>
      <button class="filter-btn metal active" data-category="metal">Металл</button>
    </div>
    <select id="point-select" class="point-selector">
      <option value="">Выберите пункт сортировки</option>
    </select>
    <button class="route-btn" onclick="buildRoute()">Построить маршрут</button>
  </div>

  <div id="route-info" class="route-info">
    <h3>Маршрут готов</h3>
    <div id="route-details"></div>
  </div>

  <!-- Leaflet JS -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <script>
    // Данные: пункты сортировки мусора
    const recyclingPoints = [
      { name: "Экоцентр на Ленинском", coords: [55.7049, 37.5655], categories: ["plastic", "paper"] },
      { name: "Пункт на Варшавке", coords: [55.6691, 37.6055], categories: ["glass", "metal"] },
      { name: "Green Point у метро Тёплый Стан", coords: [55.6102, 37.5561], categories: ["plastic", "glass", "paper"] },
      { name: "ЭкоБокс в Строгино", coords: [55.7989, 37.4056], categories: ["plastic", "metal"] },
      { name: "Пункт приёма в Люберцах", coords: [55.6803, 37.8912], categories: ["paper", "glass"] },
      { name: "Эко-станция в Бутово", coords: [55.5501, 37.6001], categories: ["plastic", "paper", "metal"] }
    ];

    let map;
    let markers = [];
    let routeLayer = null;

    document.addEventListener('DOMContentLoaded', () => {
      // Центр — Москва
      map = L.map('map').setView([55.7512, 37.6184], 10);

      // Более эстетичный тайл — CartoDB Positron (нейтральные тона)
      L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>',
        subdomains: 'abcd',
        maxZoom: 19
      }).addTo(map);

      renderPoints();
      populateSelect();

      document.querySelectorAll('.filter-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          btn.classList.toggle('active');
          renderPoints();
        });
      });
    });

    function getActiveCategories() {
      const active = {};
      document.querySelectorAll('.filter-btn.active').forEach(btn => {
        active[btn.dataset.category] = true;
      });
      return active;
    }

    function getCategoryColor(cat) {
      const colors = {
        plastic: "#3b82f6",
        paper: "#10b981",
        glass: "#ef4444",
        metal: "#f59e0b"
      };
      return colors[cat] || "#6b7280";
    }

    function catRu(cat) {
      return { plastic: "Пластик", paper: "Бумага", glass: "Стекло", metal: "Металл" }[cat] || cat;
    }

    function renderPoints() {
      markers.forEach(marker => map.removeLayer(marker));
      markers = [];

      const active = getActiveCategories();

      recyclingPoints.forEach((point, idx) => {
        if (!point.categories.some(cat => active[cat])) return;

        const color = getCategoryColor(point.categories[0]);
        const icon = L.divIcon({
          html: `<div style="
            background: ${color};
            width: 22px;
            height: 22px;
            border-radius: 50%;
            border: 2px solid white;
            box-shadow: 0 2px 6px rgba(0,0,0,0.15);
            transition: transform 0.2s;
          "></div>`,
          className: '',
          iconSize: [22, 22],
          iconAnchor: [11, 11]
        });

        const marker = L.marker([point.coords[0], point.coords[1]], { icon });
        marker.bindPopup(`
          <div style="font-family: 'Manrope', sans-serif; max-width: 200px;">
            <b style="color: #2d3748;">${point.name}</b><br/>
            <div style="margin-top: 8px;">
              ${point.categories.map(cat => 
                `<span class="category-badge ${cat}">${catRu(cat)}</span>`
              ).join('')}
            </div>
          </div>
        `);
        marker.on('click', () => {
          document.getElementById("point-select").value = idx;
        });

        marker.addTo(map);
        markers.push(marker);
      });
    }

    function populateSelect() {
      const select = document.getElementById("point-select");
      recyclingPoints.forEach((point, idx) => {
        const opt = document.createElement("option");
        opt.value = idx;
        opt.textContent = point.name;
        select.appendChild(opt);
      });
    }

    async function buildRoute() {
      const select = document.getElementById("point-select");
      const index = select.value;
      if (index === "") return alert("Пожалуйста, выберите пункт сортировки.");

      const point = recyclingPoints[index];
      const center = map.getCenter();
      const start = [center.lat, center.lng];
      const end = point.coords;

      if (routeLayer) map.removeLayer(routeLayer);

      try {
        // OSRM — бесплатный роутинг (без ключа)
        const url = `https://router.project-osrm.org/route/v1/driving/${start[1]},${start[0]};${end[1]},${end[0]}?overview=full&geometries=geojson`;
        const res = await fetch(url);
        const data = await res.json();

        if (!data.routes || data.routes.length === 0) throw new Error("No route");

        const route = data.routes[0];
        const distance = (route.distance / 1000).toFixed(1);
        const time = Math.round(route.duration / 60);

        const polyline = L.polyline(
          route.geometry.coordinates.map(c => [c[1], c[0]]),
          { color: '#4caf50', weight: 5, opacity: 0.9 }
        ).addTo(map);

        routeLayer = polyline;
        map.fitBounds(polyline.getBounds(), { padding: [50, 50] });

        document.getElementById("route-details").innerHTML = 
          `До пункта: <strong>${distance} км</strong><br/>Время в пути: <strong>~${time} мин</strong>`;
        document.getElementById("route-info").classList.add("show");
      } catch (err) {
        console.error(err);
        alert("Не удалось построить маршрут. Попробуйте позже.");
      }
    }
  </script>
</body>
</html>
